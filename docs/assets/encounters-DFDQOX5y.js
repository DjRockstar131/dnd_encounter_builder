import"./main-4kQcdMcL.js";import{g as N,m as P,a as H,l as k,d as f,b as X,c as U}from"./render-C2sAf7Np.js";const w="dnd-saved-encounters";function p(){const e=localStorage.getItem(w);try{const t=e?JSON.parse(e):[];return Array.isArray(t)?t:[]}catch{return[]}}function O(e){const t=p();t.unshift(e),localStorage.setItem(w,JSON.stringify(t.slice(0,25)))}function z(e){const t=p().filter(n=>n.id!==e);localStorage.setItem(w,JSON.stringify(t))}const F=document.querySelector("#encForm"),x=document.querySelector("#partySize"),A=document.querySelector("#partyLevel"),D=document.querySelector("#environment"),G=document.querySelector("#status"),h=document.querySelector("#grid"),B=document.querySelector("#summary"),$=document.querySelector("#loreBox"),J=document.querySelector("#newLoreBtn"),V=document.querySelector("#saveBtn"),M=document.querySelector("#savedList"),q=document.querySelector("#heroImg"),Y=document.querySelector("#heroTitle"),K=document.querySelector("#heroAttribution"),y=document.querySelector("#monsterModal"),S=document.querySelector("#modalBody"),Q=document.querySelector("#modalClose");let u=null,b=null;Q.addEventListener("click",()=>y.close());y.addEventListener("click",e=>{e.target===y&&y.close()});h.addEventListener("click",async e=>{const t=e.target.closest("button[data-action='detail']");if(!t)return;const n=t.dataset.slug;if(n)try{S.innerHTML='<p class="muted">Loading…</p>',y.showModal();const r=await N(n);S.innerHTML=P(r)}catch(r){console.error(r),S.innerHTML='<p class="muted">Could not load monster details.</p>'}});F.addEventListener("submit",async e=>{e.preventDefault();const t=Number(x.value),n=Number(A.value),r=D.value;if(!(!t||!n)){i("Generating encounter…"),h.innerHTML="",B.innerHTML="",$.innerHTML="";try{I(j(r)).catch(()=>{});const a=await R({partyLevel:n,partySize:t,environment:r}),d=W(a,t,n),s=document.createDocumentFragment();a.forEach(o=>s.appendChild(H(o,{buttonText:"View Details"}))),h.appendChild(s),_(d,t,n,r),u={id:crypto.randomUUID(),createdAt:new Date().toISOString(),partySize:t,partyLevel:n,environment:r,monsters:a.map(o=>({name:o.name,slug:o.slug,cr:o.challenge_rating,xp:C(o.challenge_rating)})),analysis:d,lore:null},i("Encounter ready. You can save it or generate lore.")}catch(a){console.error(a),i("Could not generate encounter. Try again.")}}});J.addEventListener("click",async()=>{b||(b=await Z());const e=ee(b);$.innerHTML=`
    <strong>Quest Hook</strong>
    <p class="muted" style="margin:.35rem 0 0;">${g(e)}</p>
  `,u&&(u.lore=e)});V.addEventListener("click",()=>{if(!u){i("Generate an encounter first.");return}O(u),T(),i("Saved encounter!")});M.addEventListener("click",e=>{const t=e.target.closest("button[data-action='load']"),n=e.target.closest("button[data-action='delete']");if(!t&&!n)return;const r=(t||n).dataset.id;if(!r)return;if(n){z(r),T();return}const a=p().find(s=>s.id===r);if(!a)return;x.value=a.partySize,A.value=a.partyLevel,D.value=a.environment,I(j(a.environment)).catch(()=>{}),h.innerHTML="";const d=document.createDocumentFragment();a.monsters.forEach(s=>{d.appendChild(H({name:s.name,slug:s.slug,challenge_rating:s.cr,type:"",size:"",armor_class:"",hit_points:""},{buttonText:"View Details"}))}),h.appendChild(d),_(a.analysis,a.partySize,a.partyLevel,a.environment),$.innerHTML=a.lore?`<strong>Quest Hook</strong><p class="muted" style="margin:.35rem 0 0;">${g(a.lore)}</p>`:"",u=a,i("Loaded saved encounter.")});T();i("Set party info and click Generate.");async function R({partyLevel:e,partySize:t,environment:n}){const a=Math.max(.125,Math.min(10,Math.floor(e/2)))+1,d=1+Math.floor(Math.random()*20);let o=(await k({page:d,limit:50})).results??[];o=o.filter(l=>l.slug&&l.name).filter(l=>f(l.challenge_rating)<=a),o.length<8&&(o=((await k({page:1,limit:50})).results??[]).filter(L=>f(L.challenge_rating)<=a));const v=t<=2?m(1,2):t<=4?m(2,4):m(3,6),c=[],E=new Set;for(;c.length<Math.min(v,o.length);){const l=o[m(0,o.length-1)];E.has(l.slug)||(E.add(l.slug),c.push(l))}return c.sort((l,L)=>f(l.challenge_rating)-f(L.challenge_rating)),c}function W(e,t,n){const r=e.reduce((v,c)=>v+C(c.challenge_rating),0),a=te(e.length,t),d=Math.round(r*a),s=ne(n,t);let o="Trivial";return d>=s.deadly?o="Deadly":d>=s.hard?o="Hard":d>=s.medium?o="Medium":d>=s.easy&&(o="Easy"),{baseXp:r,adjustedXp:d,multiplier:a,difficulty:o,thresholds:s,monsterCount:e.length}}function _(e,t,n,r){B.innerHTML=`
    <div class="box">
      <dt class="muted">Party</dt>
      <dd style="margin:0; font-weight:600;">${t} players • Level ${n}</dd>
    </div>
    <div class="box">
      <dt class="muted">Environment</dt>
      <dd style="margin:0; font-weight:600;">${g(r)}</dd>
    </div>
    <div class="box">
      <dt class="muted">Monsters</dt>
      <dd style="margin:0; font-weight:600;">${e.monsterCount}</dd>
    </div>
    <div class="box">
      <dt class="muted">XP</dt>
      <dd style="margin:0; font-weight:600;">Base ${e.baseXp} • Adjusted ${e.adjustedXp} (x${e.multiplier})</dd>
    </div>
    <div class="box">
      <dt class="muted">Difficulty</dt>
      <dd style="margin:0; font-weight:700;">${e.difficulty}</dd>
    </div>
  `}function T(){const e=p();if(!e.length){M.innerHTML='<p class="muted">No saved encounters yet.</p>';return}M.innerHTML=e.map(t=>`
    <div class="saved-card">
      <div>
        <strong>${g(t.environment)} • L${t.partyLevel} (${t.partySize} players)</strong>
        <p class="muted" style="margin:.25rem 0 0;">${new Date(t.createdAt).toLocaleString()} • ${g(t.analysis?.difficulty??"")} • Adjusted XP ${t.analysis?.adjustedXp??""}</p>
      </div>
      <div class="saved-actions">
        <button class="btn" data-action="load" data-id="${t.id}">Load</button>
        <button class="btn" data-action="delete" data-id="${t.id}">Delete</button>
      </div>
    </div>
  `).join("")}async function Z(){const e=await fetch("./data/lore.json");if(!e.ok)throw new Error("Could not load lore.json");return e.json()}function ee(e){const t=s=>s[m(0,s.length-1)],n=t(e.locations),r=t(e.villains),a=t(e.hooks),d=t(e.twists);return`${a} It leads to ${n}, where the party discovers ${r}. Twist: ${d}`}async function I(e){const n=(await X(e,{perPage:1,orientation:"landscape"})).results?.[0];if(!n)return;q.src=n.urls?.regular||n.urls?.full,q.alt=e;const{photographerName:r,photographerUrl:a,unsplashUrl:d}=U(n);Y.textContent=`Theme: ${e}`,K.innerHTML=`Photo by <a href="${a}" target="_blank" rel="noopener noreferrer">${r}</a> on <a href="${d}" target="_blank" rel="noopener noreferrer">Unsplash</a>.`}function j(e){return{dungeon:"fantasy dungeon corridor",forest:"enchanted forest fantasy",swamp:"misty swamp fantasy",mountain:"mountain pass fantasy",desert:"ancient desert ruins fantasy",city:"medieval city street fantasy",arctic:"frozen tundra fantasy",coast:"stormy coast fantasy",underdark:"underdark cavern fantasy"}[e]||"fantasy adventure"}function i(e){G.textContent=e}function m(e,t){return Math.floor(Math.random()*(t-e+1))+e}function g(e){return String(e).replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;").replaceAll('"',"&quot;").replaceAll("'","&#039;")}function C(e){const t={0:10,"1/8":25,"1/4":50,"1/2":100,1:200,2:450,3:700,4:1100,5:1800,6:2300,7:2900,8:3900,9:5e3,10:5900,11:7200,12:8400,13:1e4,14:11500,15:13e3,16:15e3,17:18e3,18:2e4,19:22e3,20:25e3,21:33e3,22:41e3,23:5e4,24:62e3,25:75e3,26:9e4,27:105e3,28:12e4,29:135e3,30:155e3},n=String(e??"").trim();return t[n]??0}function te(e,t){let n=1;return e===1?n=1:e===2?n=1.5:e>=3&&e<=6?n=2:e>=7&&e<=10?n=2.5:e>=11&&e<=14?n=3:n=4,t<=2?n*=1.5:t>=6&&(n*=.85),Math.round(n*100)/100}function ne(e,t){const n={1:{easy:25,medium:50,hard:75,deadly:100},2:{easy:50,medium:100,hard:150,deadly:200},3:{easy:75,medium:150,hard:225,deadly:400},4:{easy:125,medium:250,hard:375,deadly:500},5:{easy:250,medium:500,hard:750,deadly:1100},6:{easy:300,medium:600,hard:900,deadly:1400},7:{easy:350,medium:750,hard:1100,deadly:1700},8:{easy:450,medium:900,hard:1400,deadly:2100},9:{easy:550,medium:1100,hard:1600,deadly:2400},10:{easy:600,medium:1200,hard:1900,deadly:2800},11:{easy:800,medium:1600,hard:2400,deadly:3600},12:{easy:1e3,medium:2e3,hard:3e3,deadly:4500},13:{easy:1100,medium:2200,hard:3400,deadly:5100},14:{easy:1250,medium:2500,hard:3800,deadly:5700},15:{easy:1400,medium:2800,hard:4300,deadly:6400},16:{easy:1600,medium:3200,hard:4800,deadly:7200},17:{easy:2e3,medium:3900,hard:5900,deadly:8800},18:{easy:2100,medium:4200,hard:6300,deadly:9500},19:{easy:2400,medium:4900,hard:7300,deadly:10900},20:{easy:2800,medium:5700,hard:8500,deadly:12700}},r=n[Math.min(20,Math.max(1,Number(e)))]||n[1];return{easy:r.easy*t,medium:r.medium*t,hard:r.hard*t,deadly:r.deadly*t}}
